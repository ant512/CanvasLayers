<!DOCTYPE html>

<html lang="en">
	<head>
		<title>Canvas Layers</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
	</head>
	
	<body>
		<div class="container text-center" style="max-width: 1100px">
			<div class="row mt-5">
				<div class="col">
					<button id="btnNewLayer" type="button" class="btn border-dark"><i class="bi bi-square"></i> New Layer</button>
					<button id="btnNewImage" class="btn btn-outline-secondary"><i class="bi bi-image"></i> New Image</button>
					<button id="btnClearLayers" type="button" class="btn btn-outline-success"><i class="bi bi-trash-fill"></i> Clear Layer/s</button>
					<button id="btnDisplayLayers" type="button" class="btn btn-outline-danger"><i class="bi bi-layers"></i> Display Layers</button>
					<button id="btnHideLayer" type="button" class="btn btn-outline-warning"><i class="bi bi-eye-slash"></i></i> Hide Selected Layer</button>
					<button id="btnShowLayer" type="button" class="btn btn-outline-info"><i class="bi bi-eye"></i> Show Selected Layer</button>
					<button id="btnSwapLayer" type="button" class="btn btn-outline-dark"><i class="bi bi-subtract"></i> Swap Layers</button>
				</div>
			</div>
			<div class="row mt-3">
				<div class="col">
					<canvas id="canvas" class="rounded" width="700" height="500" style="border: 1px solid black;"></canvas>
				</div>
				<div class="col">
					<div class="row rounded overflow-y-auto" style="max-width: 700px; margin: 0 auto; height: 502px; border: 1px solid black;" id="layerContainerDOM">
					</div>
				</div>
			</div>
		</div>
		<script type="module">
			import ParentContainer from './js/CanvasLayerContainer.js';
			import CanvasLayer from './js/CanvasLayer.js';

			let container = new ParentContainer("canvas", "2d");
			
			let layerList = document.getElementById("layerContainerDOM");

			let btnNewLayer = document.getElementById("btnNewLayer");
			let btnNewCircle = document.getElementById("btnNewCircle");
			let btnNewImage = document.getElementById("btnNewImage");
			let btnClearLayers = document.getElementById("btnClearLayers");
			let btnToggleDisplayLayers = document.getElementById("btnDisplayLayers");
			let btnHideLayer = document.getElementById("btnHideLayer");
			let btnShowLayer = document.getElementById("btnShowLayer");
			let btnSwapLayer = document.getElementById("btnSwapLayer");

			let layerCount = 1;

			btnToggleDisplayLayers.addEventListener('click', function() {
				container.displayLayers(false);
				layerContainerDOM.innerHTML = "";

				for (let layer of container.getLayers()) {
					let columnItem = document.createElement("div");
					columnItem.classList.add("row", "mt-2", "mb-3");
					columnItem.style.maxHeight = '30px';
					let buttonItem = document.createElement("button");
					buttonItem.classList.add("btn", "btn-outline-primary", "mx-3", "my-1");
					buttonItem.style.backgroundColor = `${layer.getFillColor()}`;
					buttonItem.style.color = 'black';
					buttonItem.textContent = `${layer.getName()}`;

					buttonItem.setAttribute('data-default-name', `${layer.getName()}`);

					buttonItem.addEventListener('click', function () {
						let defaultName = buttonItem.getAttribute('data-default-name');
						let currentVisibility = layer.getLayerVisibility(); // Get the current visibility

						// Toggle the visibility of the layer
						layer.setLayerVisibility(!currentVisibility);
						buttonItem.textContent = !currentVisibility ? defaultName : `${defaultName} (hidden)`;

						// After updating the button text, trigger the click event on btnToggleDisplayLayers
						btnToggleDisplayLayers.click();	
					});
					columnItem.appendChild(buttonItem);
					layerContainerDOM.appendChild(columnItem);

					addMouseEventsToLayer(layer.getName());
				}
			});

			function getRandomColor() {
				const letters = "0123456789ABCDEF";
				let color = "#";
				for (let i = 0; i < 6; i++) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}

			function getRandomPosition(min, max) {
				const x = Math.floor(Math.random() * (max - min + 1)) + min;
				const y = Math.floor(Math.random() * (max - min + 1)) + min;
				return { x, y };
			}

			function addMouseEventsToLayer(layerName) {
				console.log("Event Triggered");
				const selectedLayer = container.selectLayer(layerName);

				if (selectedLayer) {
					let isDragging = false;
					let offsetX, offsetY;

					// Event listeners for mouse events
					container._canvas.addEventListener("mousedown", function (e) {
						console.log("Mouse Down Triggered")
						const mouseX = e.clientX - container.getCanvas().getBoundingClientRect().left;
						const mouseY = e.clientY - container.getCanvas().getBoundingClientRect().top;

						if (
							mouseX >= selectedLayer._posX &&
							mouseX <= selectedLayer._posX + selectedLayer._width &&
							mouseY >= selectedLayer._posY &&
							mouseY <= selectedLayer._posY + selectedLayer._height
						) {
							const topLayer = container._layers.reduce((prevLayer, currentLayer) => {
								if (
									mouseX >= currentLayer._posX &&
									mouseX <= currentLayer._posX + currentLayer._width &&
									mouseY >= currentLayer._posY &&
									mouseY <= currentLayer._posY + currentLayer._height
								) {
									return prevLayer._index > currentLayer._index ? prevLayer : currentLayer;
								}
								return prevLayer;
							}, selectedLayer);

							if (topLayer === selectedLayer) {
								isDragging = true;
								offsetX = mouseX - selectedLayer._posX;
								offsetY = mouseY - selectedLayer._posY;
							}
						}
					});

					container._canvas.addEventListener("mousemove", function (e) {
						if (isDragging) {
							console.log("Mouse is Dragging")
							const mouseX = e.clientX - container.getCanvas().getBoundingClientRect().left;
							const mouseY = e.clientY - container.getCanvas().getBoundingClientRect().top;

							// Calculate the new position
							const newX = mouseX - offsetX;
							const newY = mouseY - offsetY;

							// Update the position while preserving the z-index
							selectedLayer._posX = newX;
							selectedLayer._posY = newY;

							// Redraw the canvas with the updated position and z-index
							container.displayLayers(true); // Pass true to indicate that the layers are sorted by z-index
						}
					});

					container._canvas.addEventListener("mouseup", function () {
						isDragging = false;
						console.log("Mouse Up Triggered")
					});
				}
				else {
					alert("No Selected Layer");
				}
			}

			btnNewLayer.addEventListener("click", function() {
				let newLayer = new CanvasLayer('', container.getCanvas().width, container.getCanvas().height);
				newLayer.setPosX(0);
				newLayer.setPosY(0);
				newLayer.setFillColor(getRandomColor());
				newLayer.setIndex(layerCount);
				newLayer.setName(`Layer ${layerCount}`);
				newLayer.drawLayer(container.get2DContext());
				container.addLayer(newLayer);
				layerCount++;
				btnToggleDisplayLayers.click();
			});

			btnClearLayers.addEventListener('click', function() {
				let layers = container._layers;
				if (layers.length != 0) {
					let result = confirm(`Are you sure you want to clear layers?\nCurrent Layers: ${layers.length}`);
					if (result === true) {
						container._layers = [];
						container._ctx.clearRect(0, 0, container._canvas.width, container._canvas.height);
					}
				}
				else {
					alert("No layers to be removed");
				}
			});

			btnSwapLayer.addEventListener('click', function() {
				const layers = container.getLayers();
				for (let i = 1; i < layers.length; i++) {
					let fLayer = layers[i - 1];
					let sLayer = layers[i];
					container.swapLayerIndex(fLayer, sLayer);
				}
				container.displayLayers(true);
			});
		</script>
	</body>
</html>